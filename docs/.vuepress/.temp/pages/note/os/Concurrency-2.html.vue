<template><div><h2 id="SMPgv">å¹¶å‘æ§åˆ¶ - é˜»æ­¢å¹¶å‘</h2>
å¹¶å‘ç»™å¹¶å‘ç¨‹åºå¸¦æ¥äº†ä¸€ç³»åˆ—ä¸å®¹æ˜“è¢«æˆ‘ä»¬ç›´æ¥å¯Ÿè§‰çš„ bug (ä¾‹å¦‚æŸå±±å¯¨æ”¯ä»˜å®çš„é”™è¯¯æ‰£æ¬¾ä¾‹å­)ã€‚æˆ‘ä»¬æœ‰æ²¡æœ‰ä»€ä¹ˆåŠæ³•å¯ä»¥å¯¹å¹¶å‘è¿›è¡Œæ§åˆ¶å‘¢ï¼Ÿ
<p>ä¹Ÿè®¸ <strong>é˜»æ­¢å¹¶å‘</strong> æ˜¯å”¯ä¸€çš„æ–¹æ³•ã€‚ä½†æ˜¯ï¼Œå¦‚æœ <strong>é˜»æ­¢å¹¶å‘</strong> æ˜¯å¯¹å¹¶å‘è¿›è¡Œæ­£ç¡®æ§åˆ¶çš„å”¯ä¸€æ–¹æ³•ï¼Œé‚£ä¹ˆå¹¶å‘ä¸ºä»€ä¹ˆè¦å­˜åœ¨ï¼Ÿ</p>
<p><img src="@source/note/os/assets/yuque_mind_1.jpeg" alt="ç”»æ¿"></p>
<p>çœ‹èµ·æ¥ï¼Œå¹¶è¡Œæ€»å½’æ˜¯æœ‰ä½œç”¨çš„ï¼šåªè¦åœ¨ä¸éœ€è¦å¹¶å‘çš„æ—¶å€™é˜»æ­¢å¹¶å‘ï¼Œå…¶ä½™æƒ…å†µä¸‹å¯ç”¨å¹¶å‘ï¼Œå¹¶å‘æ€»èƒ½ç»™ç¨‹åºæ‰§è¡Œæé€Ÿã€‚</p>
<h2 id="UO2F0">å®ç°äº’æ–¥ - Stop the World</h2>
<p><img src="@source/note/os/assets/yuque_mind_2.jpeg" alt="ç”»æ¿"></p>
<p>ä¸ºäº†å°½å¯èƒ½é¿å…å¹¶è¡Œå¸¦æ¥çš„ä¸€ç³»åˆ— bug ï¼Œæˆ‘ä»¬è¯•å›¾é€šè¿‡æ·»åŠ <strong>é”</strong>æ¥ä¿è¯æŒ‡å®šçŠ¶æ€è¿ç§»æ­¥éª¤çš„åŸå­æ€§ã€‚ç®€å•æ¥è¯´ï¼Œå°±æ˜¯å½“æŸä¸ªçº¿ç¨‹æŒæœ‰é”çš„æ—¶å€™ï¼Œå…¶ä»–çŠ¶æ€è¿ç§»ä¸èƒ½å¤Ÿå…¥ä¾µè¯¥çº¿ç¨‹çš„çŠ¶æ€è¿ç§»è¿‡ç¨‹ï¼Œä»¥æ­¤å®ç°æŒæœ‰é”è¿‡ç¨‹ä¸­çŠ¶æ€è¿ç§»çš„åŸå­æ€§ã€‚</p>
<p>é‚£ä¹ˆå¦‚ä½•å®ç°äº’æ–¥å‘¢ï¼Ÿ</p>
<ul>
<li>å•å¤„ç†å™¨ç³»ç»Ÿï¼š<strong>å…³é—­ä¸­æ–­ (å‰¥å¤ºåˆ‡æ¢çŠ¶æ€æœºçš„èƒ½åŠ›)</strong></li>
<li>å¤šå¤„ç†å™¨ç³»ç»Ÿï¼š???</li>
</ul>
<p><img src="@source/note/os/assets/2-2.png" alt="å•å¤„ç†å™¨å…³é—­ä¸­æ–­çš„æ–¹æ³•"></p>
<p>ç„¶è€Œï¼Œé“é«˜ä¸€å°ºï¼Œé­”é«˜ä¸€ä¸ˆã€‚å¤„ç†å™¨ä¸­å­˜åœ¨ç€ <strong>NMI</strong> <font style="color:rgb(31, 35, 40);">(</font><em><font style="color:rgb(31, 35, 40);">Non-Maskable Interrupts</font></em><font style="color:rgb(31, 35, 40);">ï¼Œä¸å¯å±è”½ä¸­æ–­)ï¼Œä¾‹å¦‚æ‰ç”µä¸­æ–­ç­‰æƒ…å†µã€‚</font></p>
<font style="color:rgb(31, 35, 40);">å…³ä¸­æ–­å¹¶ä¸æ˜¯ä¸‡èƒ½çš„ï¼š</font><p><strong><font style="color:rgb(20, 20, 20);">æ“ä½œç³»ç»Ÿå¯ä»¥ï¼Œä½†æ™®é€šç¨‹åºä¸è¡Œ</font></strong></p>
<ul>
<li>
<font style="color:rgb(31, 35, 40);">ä¸­æ–­ä¿è¯äº†æ­»å¾ªç¯ä¸èƒ½æŠŠè®¡ç®—æœº â€œå¡æ­»â€</font></li>
<li>
<font style="color:rgb(31, 35, 40);">æ“ä½œç³»ç»Ÿä¸å…è®¸æ™®é€šç¨‹åºå…³ä¸­æ–­  </font><p><img src="@source/note/os/assets/2-3.png" alt="åº”ç”¨ç¨‹åºè¯•å›¾å…³ä¸­æ–­"></p>
<ul>
<li>
<font style="color:rgb(31, 35, 40);">ä½†å¦‚æœæ˜¯æ“ä½œç³»ç»Ÿä»£ç ï¼Œå®Œå…¨å¯ä»¥çŸ­æš‚å…³é—­ä¸­æ–­
    </font>
<p><img src="@source/note/os/assets/2-4.png" alt="åœ¨(è™šæ‹Ÿ)æ“ä½œç³»ç»Ÿå†…æ ¸ä¸­å…³é—­ä¸­æ–­"></p>
</li>
</ul>
</li>
</ul>
<p><strong><font style="color:rgb(20, 20, 20);">å•å¤„ç†å™¨ç³»ç»Ÿå¯ä»¥ï¼Œå¤šå¤„ç†å™¨ç³»ç»Ÿä¸è¡Œ</font></strong></p>
<ul>
<li>
<font style="color:rgb(31, 35, 40);">æ¯ä¸ªå¤„ç†å™¨æœ‰ç‹¬ç«‹çš„å¯„å­˜å™¨ç»„</font></li>
<li>ä¸­æ–­æ˜¯<strong>æ¯ä¸ªå¤„ç†å™¨å†…éƒ¨çŠ¶æ€</strong></li>
</ul>
<blockquote>
<p>å¯¹äºæ“ä½œç³»ç»Ÿä¸Šçš„åº”ç”¨ç¨‹åºï¼Œå…³é—­ä¸­æ–­æ˜¯<strong>ä¸èƒ½å®¹å¿</strong>çš„ï¼šè¿™ä¼šä½¿å¾®å°çš„ bug æˆ–æ˜¯æ¶æ„çš„ç¨‹åºç ´åè®¡ç®—æœºçš„è¿è¡Œã€‚æ“ä½œç³»ç»Ÿæ­£æ˜¯å› ä¸º<strong>ç»Ÿæ²»äº†ä¸­æ–­</strong>ï¼Œæ‰å®ç°äº†å¯¹åº”ç”¨ç¨‹åºçš„ç®¡ç†ã€‚åœ¨æ“ä½œç³»ç»Ÿå†…æ ¸çš„å®ç°ä¸­ï¼Œå…³é—­ä¸­æ–­æ˜¯ä¸€ä¸ªå¸¸è§çš„æ“ä½œã€‚</p>
</blockquote>
<hr>
<h2 id="USPAd">å®ç°äº’æ–¥ - Peterson ç®—æ³•</h2>
<h3 id="ScXky">Dekker ç®—æ³•</h3>
<blockquote>
<p>A process  <span v-pre class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi></mrow><annotation encoding="application/x-tex">P</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span></span></span></span> can enter the critical section if <strong>the other does not want to enter</strong><font style="color:rgb(101, 109, 118);">, otherwise it may enter </font><strong>only if it is its turn</strong></p>
</blockquote>
<h3 id="ZVsrD">Peterson ç®—æ³• - Dekker ç®—æ³•çš„æ”¹è¿›</h3>
<blockquote>
<p>A process <span v-pre class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi></mrow><annotation encoding="application/x-tex">P</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span></span></span></span> can enter the critical section if <strong>the other does not want to enter</strong><font style="color:rgb(101, 109, 118);">, or it has </font><strong>indicated its desire to enter (æ„å›¾)</strong><font style="color:rgb(101, 109, 118);"> and has </font><strong>given the other process the turn (è®©æ­¥)</strong>.</p>
</blockquote>
<font style="color:rgb(101, 109, 118);">ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼š</font><p><img src="https://cdn.nlark.com/yuque/0/2024/jpeg/48275148/1730430685935-13e52d3e-ecfd-471d-8371-eb741f6b9024.jpeg" alt="ç”»æ¿"></p>
<p>æ¥ç®€å•å½’çº³ä¸€ä¸‹æ¸¸æˆè§„åˆ™å§ï¼š</p>
<ul>
<li>å½“ä¸€ä¸ªçº¿ç¨‹æƒ³è¦è¿›å…¥ Critical Section æ—¶ï¼Œéœ€è¦å°†è‡ªå·±å¯¹åº”çš„<strong>æ——å­ä¸¾èµ·</strong>ï¼Œå¹¶ä¸”é¢„å…ˆå°†æ‰§è¡Œæƒé™åˆ†é…ç»™**<u>å…¶ä½™</u>**<strong>çº¿ç¨‹ä¸­çš„æŸä¸€ä¸ª</strong>(å³æ”¹å˜ turn çš„å€¼ä¸ºå¦ä¸€ä¸ªçº¿ç¨‹)ã€‚</li>
<li>åœ¨è¿™ä¸ªçº¿ç¨‹æ‰§è¡Œå®Œä¸Šè¿°è®¾ç½®æ“ä½œåï¼Œè¯¥çº¿ç¨‹å°†ä¼šè¿›å…¥æŒç»­çš„è§‚å¯Ÿè€…æ¨¡å¼ï¼š
<ul>
<li>è§‚å¯Ÿå…¶ä½™çº¿ç¨‹ä¸­æ˜¯å¦å­˜åœ¨ä¸¾æ——çš„çº¿ç¨‹ï¼Œå¦‚æœ<strong>æ²¡æœ‰</strong>åˆ™ç›´æ¥è¿›å…¥ Critical Section</li>
<li>å¦‚æœå­˜åœ¨ä¸¾æ——çº¿ç¨‹ï¼Œåˆ™è§‚å¯Ÿ turn å˜é‡çš„å€¼ (å¯ä»¥ç†è§£ä¸ºä¸‹ä¸€ä¸ªå¾…æ‰§è¡Œçš„çº¿ç¨‹)ï¼Œ<strong>å¦‚æœä¸ºè‡ªå·±</strong>åˆ™è¿›å…¥ Critical Sectionï¼Œå¦åˆ™ç»§ç»­ç­‰å¾…</li>
</ul>
</li>
<li>çº¿ç¨‹æ‰§è¡Œå®Œæˆ Critical Section åŒºåŸŸçš„ä»£ç åï¼Œéœ€è¦<strong>æ”¾ä¸‹</strong>è‡ªå·±çš„æ——å­</li>
</ul>
<p>å½“æœ‰å¤šä¸ªçº¿ç¨‹åŒæ—¶å°è¯•è¿›å…¥ Critical Section æ—¶ï¼Œçº¿ç¨‹çš„æ‰‹å¿«ç¨‹åº¦ç›´æ¥å½±å“äº†å…¶ä½™çº¿ç¨‹è¢«ä¼˜å…ˆæ‰§è¡Œçš„æ¦‚ç‡ â€”â€” ä½ å†™å…¥çš„ turn å¾ˆæœ‰å¯èƒ½ä¼šè¢«åç»­å†™å…¥çš„çº¿ç¨‹è¦†ç›–ï¼Œä½†æ˜¯ä½ å†™å…¥çš„ turn å€¼æ˜¯<strong>å…¶ä½™çº¿ç¨‹</strong>ã€‚çœ‹èµ·æ¥ Peterson's Protocal æ˜¯ä¸€ä¸ªè°¦è®©åè®®ï¼Œä½†æ˜¯å®é™…ä¸Šå®ƒæ˜¯ä¸ª<strong>åˆ©å·±</strong>åè®®ã€‚</p>
<h3 id="MWbHr">Peterson's Algorithm - å®ç°</h3>
```python
def T1():
    while True:
        heap.x = 'ğŸ´'
        sys_sched()
        heap.turn = 'â·'
        sys_sched()
        while True:
            t = heap.turn
            sys_sched()
            y = heap.y != ''
            sys_sched()
            if not y or t == 'â¶':
                break
        sys_sched()
        heap.cs += 'â¶'
        sys_sched()
        heap.cs = heap.cs.replace('â¶', '')
        sys_sched()
        heap.x = ''
        sys_sched()
<p>def T2():
while True:
heap.y = 'ğŸ'
sys_sched()
heap.turn = 'â¶'
sys_sched()
while True:
t = heap.turn
sys_sched()
x = heap.x
sys_sched()
if not x or t == 'â·':
break
sys_sched()
sys_sched()
heap.cs += 'â·'
sys_sched()
heap.cs = heap.cs.replace('â·', '')
sys_sched()
heap.y = ''
sys_sched()</p>
<p>def main():
heap.x = ''
heap.y = ''
heap.turn = ''
heap.cs = ''
sys_spawn(T1)
sys_spawn(T2)</p>
<div class="language-text line-numbers-mode line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre v-pre  class="shiki nord vp-code" style="background-color:#2e3440ff;color:#d8dee9ff language-text"><code><span class="line"><span class="line"><span></span></span></span>
<span class="line"><span class="line"><span>ä¸Šé¢çš„ä»£ç åœ¨æˆ‘ä»¬çš„ Model Checker ä¸Šæ‰§è¡Œçš„ç»“æœæ˜¯æ­£ç¡®çš„ã€‚</span></span></span>
<span class="line"><span class="line"><span></span></span></span>
<span class="line"><span class="line"><span>ä½†æ˜¯ï¼Œå¦‚æœåœ¨ç°ä»£â€œç¼–è¯‘å™¨åŒ–â€çš„å¤„ç†å™¨ä¸Šæ‰§è¡Œï¼Œä¼šè¾“å‡ºæ­£ç¡®çš„ç»“æœå—ï¼Ÿ</span></span></span>
<span class="line"><span class="line"><span></span></span></span>
<span class="line"><span class="line"><span>ç­”æ¡ˆæ˜¯å¦å®šçš„ã€‚</span></span></span>
<span class="line"><span class="line"><span></span></span></span>
<span class="line"><span class="line"><span>æˆ‘ä»¬é‡æ–°ç”¨ C è¯­è¨€ç¼–å†™äº†ä¸€ä¸ª Peterson's Algorithm çš„å®ç°ï¼š</span></span></span>
<span class="line"><span class="line"><span></span></span></span>
<span class="line"><span class="line"><span>```c</span></span></span>
<span class="line"><span class="line"><span>#include "thread.h"</span></span></span>
<span class="line"><span class="line"><span>#include &#x3C;stdatomic.h></span></span></span>
<span class="line"><span class="line"><span></span></span></span>
<span class="line"><span class="line"><span>#define A 1</span></span></span>
<span class="line"><span class="line"><span>#define B 2</span></span></span>
<span class="line"><span class="line"><span></span></span></span>
<span class="line"><span class="line"><span>// The caveat is: no matter how many times we run this test</span></span></span>
<span class="line"><span class="line"><span>// without seeing it fail, we cannot be certain that we have</span></span></span>
<span class="line"><span class="line"><span>// inserted sufficient barriers. Understanding the correctness</span></span></span>
<span class="line"><span class="line"><span>// of this code is far beyond the scope of this course.</span></span></span>
<span class="line"><span class="line"><span>// </span></span></span>
<span class="line"><span class="line"><span>// #define BARRIER __sync_synchronize()</span></span></span>
<span class="line"><span class="line"><span>//</span></span></span>
<span class="line"><span class="line"><span>// Peterson's algorithm is wrong without proper barriers:</span></span></span>
<span class="line"><span class="line"><span>//</span></span></span>
<span class="line"><span class="line"><span>#define BARRIER</span></span></span>
<span class="line"><span class="line"><span></span></span></span>
<span class="line"><span class="line"><span>atomic_int inside;</span></span></span>
<span class="line"><span class="line"><span>long count;</span></span></span>
<span class="line"><span class="line"><span></span></span></span>
<span class="line"><span class="line"><span>void critical_section() {</span></span></span>
<span class="line"><span class="line"><span>    // We expect this thread executing code exclusively,</span></span></span>
<span class="line"><span class="line"><span>    // if the critical section is correctly implemented.</span></span></span>
<span class="line"><span class="line"><span> </span></span></span>
<span class="line"><span class="line"><span>    assert(</span></span></span>
<span class="line"><span class="line"><span>        // assert(inside == 0);</span></span></span>
<span class="line"><span class="line"><span>        // inside++</span></span></span>
<span class="line"><span class="line"><span>        atomic_fetch_add(&#x26;inside, +1) == 0</span></span></span>
<span class="line"><span class="line"><span>    );</span></span></span>
<span class="line"><span class="line"><span></span></span></span>
<span class="line"><span class="line"><span>    // On some machines, printing a character will hide</span></span></span>
<span class="line"><span class="line"><span>    // the bug!</span></span></span>
<span class="line"><span class="line"><span>    // putchar('.');</span></span></span>
<span class="line"><span class="line"><span></span></span></span>
<span class="line"><span class="line"><span>    assert(</span></span></span>
<span class="line"><span class="line"><span>        // assert(inside == 1);</span></span></span>
<span class="line"><span class="line"><span>        // inside--</span></span></span>
<span class="line"><span class="line"><span>        atomic_fetch_add(&#x26;inside, -1) == 1</span></span></span>
<span class="line"><span class="line"><span>    );</span></span></span>
<span class="line"><span class="line"><span>}</span></span></span>
<span class="line"><span class="line"><span></span></span></span>
<span class="line"><span class="line"><span>int volatile a = 0, b = 0, turn;</span></span></span>
<span class="line"><span class="line"><span></span></span></span>
<span class="line"><span class="line"><span>void T_A() {</span></span></span>
<span class="line"><span class="line"><span>    while (1) {</span></span></span>
<span class="line"><span class="line"><span>        a = 1;                    BARRIER;</span></span></span>
<span class="line"><span class="line"><span>        turn = B;                 BARRIER; // &#x3C;- this is critcal for x86</span></span></span>
<span class="line"><span class="line"><span>        while (1) {</span></span></span>
<span class="line"><span class="line"><span>            if (!b) break;        BARRIER;</span></span></span>
<span class="line"><span class="line"><span>            if (turn != B) break; BARRIER;</span></span></span>
<span class="line"><span class="line"><span>        }</span></span></span>
<span class="line"><span class="line"><span></span></span></span>
<span class="line"><span class="line"><span>        // T_B can't execute critical_section now.</span></span></span>
<span class="line"><span class="line"><span>        critical_section();</span></span></span>
<span class="line"><span class="line"><span></span></span></span>
<span class="line"><span class="line"><span>        a = 0;                    BARRIER;</span></span></span>
<span class="line"><span class="line"><span>    }</span></span></span>
<span class="line"><span class="line"><span>}</span></span></span>
<span class="line"><span class="line"><span></span></span></span>
<span class="line"><span class="line"><span>void T_B() {</span></span></span>
<span class="line"><span class="line"><span>    while (1) {</span></span></span>
<span class="line"><span class="line"><span>        b = 1;                    BARRIER;</span></span></span>
<span class="line"><span class="line"><span>        turn = A;                 BARRIER;</span></span></span>
<span class="line"><span class="line"><span>        while (1) {</span></span></span>
<span class="line"><span class="line"><span>            if (!a) break;        BARRIER;</span></span></span>
<span class="line"><span class="line"><span>            if (turn != A) break; BARRIER;</span></span></span>
<span class="line"><span class="line"><span>        }</span></span></span>
<span class="line"><span class="line"><span></span></span></span>
<span class="line"><span class="line"><span>        // T_A can't execute critical_section now.</span></span></span>
<span class="line"><span class="line"><span>        critical_section();</span></span></span>
<span class="line"><span class="line"><span></span></span></span>
<span class="line"><span class="line"><span>        b = 0;                    BARRIER;</span></span></span>
<span class="line"><span class="line"><span>    }</span></span></span>
<span class="line"><span class="line"><span>}</span></span></span>
<span class="line"><span class="line"><span></span></span></span>
<span class="line"><span class="line"><span>int main() {</span></span></span>
<span class="line"><span class="line"><span>    create(T_A);</span></span></span>
<span class="line"><span class="line"><span>    create(T_B);</span></span></span>
<span class="line"><span class="line"><span>}</span></span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿è¡Œç»“æœï¼š</p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/48275148/1730437705076-29148737-d53f-41b1-bd81-92e939ac392a.png" alt="æ‰§è¡Œå¤±è´¥ç¤ºä¾‹"></p>
<p>æˆ‘ä»¬ç»™å®ƒé‡æ–°åŠ å› Barrier ä¹‹åï¼Œä¼šæ€ä¹ˆæ ·å‘¢ï¼Ÿ</p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/48275148/1730437839381-9b136d2f-827c-4678-806d-5f75cde287c5.png" alt="ç¨‹åºä¼¼ä¹æ­£å¸¸è¿è¡Œäº†"></p>
<p>è™½ç„¶åŠ äº† Barrier èƒ½å¤Ÿä½¿ç¨‹åºçš„è¡Œä¸ºå˜å¾—â€œçœ‹èµ·æ¥â€æ­£ç¡®ï¼Œä½†æ˜¯ä½ èƒ½ç¡®å®š**<font style="color:rgb(68, 136, 204);">å“ªäº›åœ°æ–¹çš„ barrier æ˜¯ä¸å¯å°‘çš„å—</font>**<font style="color:rgb(31, 35, 40);">ï¼Ÿ</font></p>
<font style="color:rgb(31, 35, 40);">å› ä¸º Peterson ç®—æ³•åœ¨ç°ä»£å¤„ç†å™¨ä¸Šéœ€è¦æ·»åŠ è®¸å¤šå±éšœ(æˆ–è®¸æœ‰è®¸å¤šåœ°æ–¹å¯ä»¥ä¼˜åŒ–ï¼Œä½†æ˜¯ä½ åŸºæœ¬ä¸Šæ— æ³•ç¡®å®šå“ªäº›åœ°æ–¹çš„å±éšœæ˜¯å¿…ä¸å¯å°‘çš„)ï¼Œæ‰€ä»¥è¯¥ç®—æ³•åœ¨ç°åœ¨å·²ç»ä¸æ€ä¹ˆä½¿ç”¨äº†ã€‚</font><h2 id="kRUYV"><font style="color:rgb(31, 35, 40);">å¤šå¤„ç†å™¨ç³»ç»Ÿä¸Šçš„äº’æ–¥</font></h2>
å®é™…ä¸Šï¼Œäº’æ–¥çš„æ ¹æœ¬ç›®çš„æ˜¯ä¸ºäº†ä¿è¯ Critical Section æ“ä½œçš„**åŸå­æ€§**ã€‚
<p>ä¸ºäº†åœ¨è½¯ä»¶æ–¹é¢å®ç°åŸå­è¿ç§»ï¼Œäººç±»æå‡ºäº† Dekker ç®—æ³•ã€Peterson ç®—æ³•...ç”šè‡³è¿˜éœ€è¦åŠ è£…è®¸å¤šä½ æ— æ³•å®Œå…¨ç¡®å®šå¦‚ä½•ä¼˜åŒ–çš„å±éšœæ¥ä¿è¯æ­£ç¡®æ€§...</p>
<p>ä½†æ˜¯ï¼Œåœ¨è®¡ç®—æœºä¸Šï¼Œè½¯ç¡¬ä»¶æ˜¯äº’è¡¥çš„ï¼Œå› æ­¤â€œ<strong>è½¯ä»¶ä¸å¤Ÿï¼Œç¡¬ä»¶æ¥å‡‘</strong>â€ã€‚</p>
<p>å¦‚æœè¦åœ¨ç¡¬ä»¶æ–¹é¢å®ç°äº’æ–¥ä»¥ä¿è¯ Critical Section æ“ä½œçš„åŸå­æ€§ï¼Œæˆ‘ä»¬ä¹Ÿè®¸å¯ä»¥å°å°çš„å€Ÿç”¨ä¸€ä¸‹ Stop the World çš„èƒ½åŠ› â€”â€” ä½¿ç”¨åŸå­æŒ‡ä»¤ã€‚</p>
<p>åŸå­æŒ‡ä»¤æä¾›äº†ä¸€å°æ®µæ—¶é—´çš„â€œStop the Worldâ€æ‰§è¡Œèƒ½åŠ›ï¼Œä¸ºçŠ¶æ€è¿ç§»çš„åŸå­æ€§åšäº†ä¿è¯ã€‚</p>
<ul>
<li>
<font style="color:rgb(31, 35, 40);">ä¸å¯æ‰“æ–­çš„ load + è®¡ç®— + store</font><ul>
<li>
<font style="color:rgb(31, 35, 40);">x86: Bus Lock; RISC-V: LR/SC (æ¥è‡ª MIPS) + atomic</font></li>
</ul>
</li>
</ul>
<font style="color:rgb(31, 35, 40);">æœ‰äº†åŸå­æŒ‡ä»¤ï¼Œæ€»ç®—å¯ä»¥åœ¨å¤šå¤„ç†å™¨ä¸Šå®ç° å¹¶è¡Œ 1 + 1 äº†ï¼</font><h3 id="reftG"><font style="color:rgb(31, 35, 40);">åŸå­æŒ‡ä»¤å®ç°è‡ªæ—‹é”</font></h3>
> è‡ªæ—‹é”:
<div class="language-c line-numbers-mode line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre v-pre  class="shiki nord vp-code" style="background-color:#2e3440ff;color:#d8dee9ff language-c"><code><span class="line"><span class="line"><span style="color:#81A1C1">int</span><span style="color:#D8DEE9FF"> status </span><span style="color:#81A1C1">=</span><span style="color:#D8DEE9FF"> âœ…</span><span style="color:#81A1C1">;</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#616E88">// è¿™ä¸ªè¿›ç¨‹çŠ¶æ€æœºä¸­åªå­˜åœ¨ä¸€ä¸ªâœ…</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1">void</span><span style="color:#88C0D0"> lock</span><span style="color:#ECEFF4">()</span><span style="color:#ECEFF4"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9FF">retry:</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1">    int</span><span style="color:#D8DEE9FF"> got </span><span style="color:#81A1C1">=</span><span style="color:#88C0D0"> atomic_xchg</span><span style="color:#ECEFF4">(</span><span style="color:#81A1C1">&#x26;</span><span style="color:#D8DEE9FF">status</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9FF"> âŒ</span><span style="color:#ECEFF4">)</span><span style="color:#81A1C1">;</span><span style="color:#616E88"> // åŸå­äº¤æ¢æŒ‡ä»¤</span></span></span>
<span class="line"><span class="line"><span style="color:#616E88">    // æ‰‹æ…¢çš„è¿›ç¨‹ä¼šä¸€ç›´åœ¨è¿™é‡Œâ€œè‡ªæ—‹â€</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1">    if</span><span style="color:#ECEFF4"> (</span><span style="color:#D8DEE9FF">got </span><span style="color:#81A1C1">!=</span><span style="color:#D8DEE9FF"> âœ…</span><span style="color:#ECEFF4">)</span><span style="color:#ECEFF4"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1">        goto</span><span style="color:#D8DEE9FF"> retry</span><span style="color:#81A1C1">;</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4">    }</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4">}</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1">void</span><span style="color:#88C0D0"> unlock</span><span style="color:#ECEFF4">()</span><span style="color:#ECEFF4"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#88C0D0">    atomic_xchg</span><span style="color:#ECEFF4">(</span><span style="color:#81A1C1">&#x26;</span><span style="color:#D8DEE9FF">status</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9FF"> âœ…</span><span style="color:#ECEFF4">)</span><span style="color:#81A1C1">;</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4">}</span></span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="HzbuS">ä¸€æ ¸è‡ªæ—‹ä¸­æ–­ï¼Œå¤šæ ¸è‡ªæ—‹ï¼Ÿ</h3>
è§£å†³æ–¹æ¡ˆï¼šæ“ä½œç³»ç»ŸçŸ­æš‚å…³ä¸­æ–­
</div></template>


