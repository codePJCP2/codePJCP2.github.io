<template><div><h1 id="并发-2-并发控制-互斥-1" tabindex="-1"><a class="header-anchor" href="#并发-2-并发控制-互斥-1"><span>并发 - 2：并发控制 - 互斥 (1)</span></a></h1>
<h2 id="并发控制-阻止并发" tabindex="-1"><a class="header-anchor" href="#并发控制-阻止并发"><span>并发控制 - 阻止并发</span></a></h2>
<p>并发给并发程序带来了一系列不容易被我们直接察觉的 bug (例如某山寨支付宝的错误扣款例子)。我们有没有什么办法可以对并发进行控制呢？</p>
<p>也许 <strong>阻止并发</strong> 是唯一的方法。但是，如果 <strong>阻止并发</strong> 是对并发进行正确控制的唯一方法，那么并发为什么要存在？</p>
<p><img src="@source/learning-path/os/NJU-OS/note/img/ixRRllTon6wU14pl/1730356467740-7a6675d7-95b8-49d6-b23e-b7ffa827944a-277438.jpeg" alt="画板"></p>
<p>看起来，并行总归是有作用的：只要在不需要并发的时候阻止并发，其余情况下启用并发，并发总能给程序执行提速。</p>
<h2 id="实现互斥-stop-the-world" tabindex="-1"><a class="header-anchor" href="#实现互斥-stop-the-world"><span>实现互斥 - Stop the World</span></a></h2>
<p><img src="@source/learning-path/os/NJU-OS/note/img/ixRRllTon6wU14pl/1730425742223-837a614e-c7cf-41e0-8e04-3f9e66f6f4bf-105552.jpeg" alt="画板"></p>
<p>为了尽可能避免并行带来的一系列 bug ，我们试图通过添加<strong>锁</strong>来保证指定状态迁移步骤的原子性。简单来说，就是当某个线程持有锁的时候，其他状态迁移不能够入侵该线程的状态迁移过程，以此实现持有锁过程中状态迁移的原子性。</p>
<p>那么如何实现互斥呢？</p>
<ul>
<li>单处理器系统：<strong>关闭中断 (剥夺切换状态机的能力)</strong></li>
<li>多处理器系统：???</li>
</ul>
<p><img src="@source/learning-path/os/NJU-OS/note/img/ixRRllTon6wU14pl/1730426249610-4b24830e-bde7-4baa-9c0f-dd5c16fa5231-011831.png" alt="单处理器关闭中断的方法"></p>
<p>然而，道高一尺，魔高一丈。处理器中存在着 <strong>NMI</strong> <font style="color:rgb(31, 35, 40);">(</font><em><font style="color:rgb(31, 35, 40);">Non-Maskable Interrupts</font></em><font style="color:rgb(31, 35, 40);">，不可屏蔽中断)，例如掉电中断等情况。</font></p>
<font style="color:rgb(31, 35, 40);">关中断并不是万能的：</font><p><strong><font style="color:rgb(20, 20, 20);">操作系统可以，但普通程序不行</font></strong></p>
<ul>
<li>
<font style="color:rgb(31, 35, 40);">中断保证了死循环不能把计算机 “卡死”</font></li>
<li>
<font style="color:rgb(31, 35, 40);">操作系统不允许普通程序关中断  
</li>
</ul>
</font>![应用程序试图关中断](./img/ixRRllTon6wU14pl/1730426907196-3be3cdd2-668a-43bc-866f-932bac4adb2d-443051.png)
    - <font style="color:rgb(31, 35, 40);">但如果是操作系统代码，完全可以短暂关闭中断  
</font>![在(虚拟)操作系统内核中关闭中断](./img/ixRRllTon6wU14pl/1730427050137-69ebf097-1ecf-4d9b-8bd2-c29f04cd80e7-022928.png)
<p><strong><font style="color:rgb(20, 20, 20);">单处理器系统可以，多处理器系统不行</font></strong></p>
<ul>
<li>
<font style="color:rgb(31, 35, 40);">每个处理器有独立的寄存器组</font></li>
<li>
<font style="color:rgb(31, 35, 40);">中断是</font>**<font style="color:rgb(31, 35, 40);">每个处理器内部状态</font>**</li>
</ul>
<blockquote>
<font style="color:rgb(15, 23, 42);">对于操作系统上的应用程序，关闭中断是</font>**<font style="color:rgb(15, 23, 42);">不能容忍</font>**<font style="color:rgb(15, 23, 42);">的：这会使微小的 bug 或是恶意的程序破坏计算机的运行。操作系统正是因为统治了中断，才实现了对应用程序的管理。在操作系统内核的实现中，关闭中断是一个常见的操作。</font></blockquote>
<h2 id="实现互斥-peterson-算法" tabindex="-1"><a class="header-anchor" href="#实现互斥-peterson-算法"><span>实现互斥 - Peterson 算法</span></a></h2>
<h3 id="dekker-算法" tabindex="-1"><a class="header-anchor" href="#dekker-算法"><span>Dekker 算法</span></a></h3>
<blockquote>
<font style="color:rgb(101, 109, 118);">A process </font>$ P $<font style="color:rgb(101, 109, 118);"> can enter the critical section if </font>**<font style="color:rgb(101, 109, 118);">the other does not want to enter</font>**<font style="color:rgb(101, 109, 118);">, otherwise it may enter </font>**<font style="color:rgb(101, 109, 118);">only if it is its turn</font>**<font style="color:rgb(101, 109, 118);">.</font></blockquote>
<h3 id="peterson-算法-dekker-算法的改进" tabindex="-1"><a class="header-anchor" href="#peterson-算法-dekker-算法的改进"><span>Peterson 算法 - Dekker 算法的改进</span></a></h3>
<blockquote>
<font style="color:rgb(101, 109, 118);">A process </font>$ P $<font style="color:rgb(101, 109, 118);"> can enter the critical section if </font>**<font style="color:rgb(101, 109, 118);">the other does not want to enter</font>**<font style="color:rgb(101, 109, 118);">, or it has </font>**<font style="color:rgb(101, 109, 118);">indicated its desire to enter (意图)</font>**<font style="color:rgb(101, 109, 118);"> and has </font>**<font style="color:rgb(101, 109, 118);">given the other process the turn (让步)</font>**<font style="color:rgb(101, 109, 118);">.</font></blockquote>
<font style="color:rgb(101, 109, 118);">一个简单的例子：</font><p><img src="@source/learning-path/os/NJU-OS/note/img/ixRRllTon6wU14pl/1730430685935-13e52d3e-ecfd-471d-8371-eb741f6b9024-689355.jpeg" alt="画板"></p>
<p>来简单归纳一下游戏规则吧：</p>
<ul>
<li>当一个线程想要进入 Critical Section 时，需要将自己对应的<strong>旗子举起</strong>，并且预先将执行权限分配给**<u>其余</u>**<strong>线程中的某一个</strong>(即改变 turn 的值为另一个线程)。</li>
<li>在这个线程执行完上述设置操作后，该线程将会进入持续的观察者模式：
<ul>
<li>观察其余线程中是否存在举旗的线程，如果<strong>没有</strong>则直接进入 Critical Section</li>
<li>如果存在举旗线程，则观察 turn 变量的值 (可以理解为下一个待执行的线程)，<strong>如果为自己</strong>则进入 Critical Section，否则继续等待</li>
</ul>
</li>
<li>线程执行完成 Critical Section 区域的代码后，需要<strong>放下</strong>自己的旗子</li>
</ul>
<p>当有多个线程同时尝试进入 Critical Section 时，线程的手快程度直接影响了其余线程被优先执行的概率 —— 你写入的 turn 很有可能会被后续写入的线程覆盖，但是你写入的 turn 值是<strong>其余线程</strong>。看起来 Peterson's Protocal 是一个谦让协议，但是实际上它是个<strong>利己</strong>协议。</p>
<h3 id="peterson-s-algorithm-实现" tabindex="-1"><a class="header-anchor" href="#peterson-s-algorithm-实现"><span>Peterson's Algorithm - 实现</span></a></h3>
<div class="language-python line-numbers-mode line-numbers-mode" data-highlighter="prismjs" data-ext="py" data-title="py"><pre v-pre  class="shiki nord vp-code" style="background-color:#2e3440ff;color:#d8dee9ff language-python"><code><span class="line"><span class="line"><span style="color:#81A1C1">def</span><span style="color:#88C0D0"> T1</span><span style="color:#ECEFF4">():</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1">    while</span><span style="color:#81A1C1"> True</span><span style="color:#ECEFF4">:</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9FF">        heap</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9FF">x </span><span style="color:#81A1C1">=</span><span style="color:#ECEFF4"> '</span><span style="color:#A3BE8C">🏴</span><span style="color:#ECEFF4">'</span></span></span>
<span class="line"><span class="line"><span style="color:#88C0D0">        sys_sched</span><span style="color:#ECEFF4">()</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9FF">        heap</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9FF">turn </span><span style="color:#81A1C1">=</span><span style="color:#ECEFF4"> '</span><span style="color:#A3BE8C">❷</span><span style="color:#ECEFF4">'</span></span></span>
<span class="line"><span class="line"><span style="color:#88C0D0">        sys_sched</span><span style="color:#ECEFF4">()</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1">        while</span><span style="color:#81A1C1"> True</span><span style="color:#ECEFF4">:</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9FF">            t </span><span style="color:#81A1C1">=</span><span style="color:#D8DEE9FF"> heap</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9FF">turn</span></span></span>
<span class="line"><span class="line"><span style="color:#88C0D0">            sys_sched</span><span style="color:#ECEFF4">()</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9FF">            y </span><span style="color:#81A1C1">=</span><span style="color:#D8DEE9FF"> heap</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9FF">y </span><span style="color:#81A1C1">!=</span><span style="color:#ECEFF4"> ''</span></span></span>
<span class="line"><span class="line"><span style="color:#88C0D0">            sys_sched</span><span style="color:#ECEFF4">()</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1">            if</span><span style="color:#81A1C1"> not</span><span style="color:#D8DEE9FF"> y </span><span style="color:#81A1C1">or</span><span style="color:#D8DEE9FF"> t </span><span style="color:#81A1C1">==</span><span style="color:#ECEFF4"> '</span><span style="color:#A3BE8C">❶</span><span style="color:#ECEFF4">'</span><span style="color:#ECEFF4">:</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1">                break</span></span></span>
<span class="line"><span class="line"><span style="color:#88C0D0">        sys_sched</span><span style="color:#ECEFF4">()</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9FF">        heap</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9FF">cs </span><span style="color:#81A1C1">+=</span><span style="color:#ECEFF4"> '</span><span style="color:#A3BE8C">❶</span><span style="color:#ECEFF4">'</span></span></span>
<span class="line"><span class="line"><span style="color:#88C0D0">        sys_sched</span><span style="color:#ECEFF4">()</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9FF">        heap</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9FF">cs </span><span style="color:#81A1C1">=</span><span style="color:#D8DEE9FF"> heap</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9FF">cs</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">replace</span><span style="color:#ECEFF4">(</span><span style="color:#ECEFF4">'</span><span style="color:#A3BE8C">❶</span><span style="color:#ECEFF4">'</span><span style="color:#ECEFF4">,</span><span style="color:#ECEFF4"> ''</span><span style="color:#ECEFF4">)</span></span></span>
<span class="line"><span class="line"><span style="color:#88C0D0">        sys_sched</span><span style="color:#ECEFF4">()</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9FF">        heap</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9FF">x </span><span style="color:#81A1C1">=</span><span style="color:#ECEFF4"> ''</span></span></span>
<span class="line"><span class="line"><span style="color:#88C0D0">        sys_sched</span><span style="color:#ECEFF4">()</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9FF"> </span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1">def</span><span style="color:#88C0D0"> T2</span><span style="color:#ECEFF4">():</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1">    while</span><span style="color:#81A1C1"> True</span><span style="color:#ECEFF4">:</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9FF">        heap</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9FF">y </span><span style="color:#81A1C1">=</span><span style="color:#ECEFF4"> '</span><span style="color:#A3BE8C">🏁</span><span style="color:#ECEFF4">'</span></span></span>
<span class="line"><span class="line"><span style="color:#88C0D0">        sys_sched</span><span style="color:#ECEFF4">()</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9FF">        heap</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9FF">turn </span><span style="color:#81A1C1">=</span><span style="color:#ECEFF4"> '</span><span style="color:#A3BE8C">❶</span><span style="color:#ECEFF4">'</span></span></span>
<span class="line"><span class="line"><span style="color:#88C0D0">        sys_sched</span><span style="color:#ECEFF4">()</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1">        while</span><span style="color:#81A1C1"> True</span><span style="color:#ECEFF4">:</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9FF">            t </span><span style="color:#81A1C1">=</span><span style="color:#D8DEE9FF"> heap</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9FF">turn</span></span></span>
<span class="line"><span class="line"><span style="color:#88C0D0">            sys_sched</span><span style="color:#ECEFF4">()</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9FF">            x </span><span style="color:#81A1C1">=</span><span style="color:#D8DEE9FF"> heap</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9FF">x</span></span></span>
<span class="line"><span class="line"><span style="color:#88C0D0">            sys_sched</span><span style="color:#ECEFF4">()</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1">            if</span><span style="color:#81A1C1"> not</span><span style="color:#D8DEE9FF"> x </span><span style="color:#81A1C1">or</span><span style="color:#D8DEE9FF"> t </span><span style="color:#81A1C1">==</span><span style="color:#ECEFF4"> '</span><span style="color:#A3BE8C">❷</span><span style="color:#ECEFF4">'</span><span style="color:#ECEFF4">:</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1">                break</span></span></span>
<span class="line"><span class="line"><span style="color:#88C0D0">            sys_sched</span><span style="color:#ECEFF4">()</span></span></span>
<span class="line"><span class="line"><span style="color:#88C0D0">        sys_sched</span><span style="color:#ECEFF4">()</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9FF">        heap</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9FF">cs </span><span style="color:#81A1C1">+=</span><span style="color:#ECEFF4"> '</span><span style="color:#A3BE8C">❷</span><span style="color:#ECEFF4">'</span></span></span>
<span class="line"><span class="line"><span style="color:#88C0D0">        sys_sched</span><span style="color:#ECEFF4">()</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9FF">        heap</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9FF">cs </span><span style="color:#81A1C1">=</span><span style="color:#D8DEE9FF"> heap</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9FF">cs</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">replace</span><span style="color:#ECEFF4">(</span><span style="color:#ECEFF4">'</span><span style="color:#A3BE8C">❷</span><span style="color:#ECEFF4">'</span><span style="color:#ECEFF4">,</span><span style="color:#ECEFF4"> ''</span><span style="color:#ECEFF4">)</span></span></span>
<span class="line"><span class="line"><span style="color:#88C0D0">        sys_sched</span><span style="color:#ECEFF4">()</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9FF">        heap</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9FF">y </span><span style="color:#81A1C1">=</span><span style="color:#ECEFF4"> ''</span></span></span>
<span class="line"><span class="line"><span style="color:#88C0D0">        sys_sched</span><span style="color:#ECEFF4">()</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1">def</span><span style="color:#88C0D0"> main</span><span style="color:#ECEFF4">():</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9FF">    heap</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9FF">x </span><span style="color:#81A1C1">=</span><span style="color:#ECEFF4"> ''</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9FF">    heap</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9FF">y </span><span style="color:#81A1C1">=</span><span style="color:#ECEFF4"> ''</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9FF">    heap</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9FF">turn </span><span style="color:#81A1C1">=</span><span style="color:#ECEFF4"> ''</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9FF">    heap</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9FF">cs </span><span style="color:#81A1C1">=</span><span style="color:#ECEFF4"> ''</span></span></span>
<span class="line"><span class="line"><span style="color:#88C0D0">    sys_spawn</span><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9FF">T1</span><span style="color:#ECEFF4">)</span></span></span>
<span class="line"><span class="line"><span style="color:#88C0D0">    sys_spawn</span><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9FF">T2</span><span style="color:#ECEFF4">)</span></span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>上面的代码在我们的 Model Checker 上执行的结果是正确的。</p>
<p>但是，如果在现代“编译器化”的处理器上执行，会输出正确的结果吗？</p>
<p>答案是否定的。</p>
<p>我们重新用 C 语言编写了一个 Peterson's Algorithm 的实现：</p>
<div class="language-c line-numbers-mode line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre v-pre  class="shiki nord vp-code" style="background-color:#2e3440ff;color:#d8dee9ff language-c"><code><span class="line"><span class="line"><span style="color:#5E81AC;font-weight:bold">#</span><span style="color:#81A1C1">include</span><span style="color:#ECEFF4"> "</span><span style="color:#A3BE8C">thread.h</span><span style="color:#ECEFF4">"</span></span></span>
<span class="line"><span class="line"><span style="color:#5E81AC;font-weight:bold">#</span><span style="color:#81A1C1">include</span><span style="color:#ECEFF4"> &#x3C;</span><span style="color:#8FBCBB">stdatomic.h</span><span style="color:#ECEFF4">></span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#5E81AC;font-weight:bold">#</span><span style="color:#81A1C1">define</span><span style="color:#88C0D0"> A</span><span style="color:#B48EAD"> 1</span></span></span>
<span class="line"><span class="line"><span style="color:#5E81AC;font-weight:bold">#</span><span style="color:#81A1C1">define</span><span style="color:#88C0D0"> B</span><span style="color:#B48EAD"> 2</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#616E88">// The caveat is: no matter how many times we run this test</span></span></span>
<span class="line"><span class="line"><span style="color:#616E88">// without seeing it fail, we cannot be certain that we have</span></span></span>
<span class="line"><span class="line"><span style="color:#616E88">// inserted sufficient barriers. Understanding the correctness</span></span></span>
<span class="line"><span class="line"><span style="color:#616E88">// of this code is far beyond the scope of this course.</span></span></span>
<span class="line"><span class="line"><span style="color:#616E88">// </span></span></span>
<span class="line"><span class="line"><span style="color:#616E88">// #define BARRIER __sync_synchronize()</span></span></span>
<span class="line"><span class="line"><span style="color:#616E88">//</span></span></span>
<span class="line"><span class="line"><span style="color:#616E88">// Peterson's algorithm is wrong without proper barriers:</span></span></span>
<span class="line"><span class="line"><span style="color:#616E88">//</span></span></span>
<span class="line"><span class="line"><span style="color:#5E81AC;font-weight:bold">#</span><span style="color:#81A1C1">define</span><span style="color:#88C0D0"> BARRIER</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1">atomic_int</span><span style="color:#D8DEE9FF"> inside</span><span style="color:#81A1C1">;</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1">long</span><span style="color:#D8DEE9FF"> count</span><span style="color:#81A1C1">;</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1">void</span><span style="color:#88C0D0"> critical_section</span><span style="color:#ECEFF4">()</span><span style="color:#ECEFF4"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#616E88">    // We expect this thread executing code exclusively,</span></span></span>
<span class="line"><span class="line"><span style="color:#616E88">    // if the critical section is correctly implemented.</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9FF"> </span></span></span>
<span class="line"><span class="line"><span style="color:#88C0D0">    assert</span><span style="color:#ECEFF4">(</span></span></span>
<span class="line"><span class="line"><span style="color:#616E88">        // assert(inside == 0);</span></span></span>
<span class="line"><span class="line"><span style="color:#616E88">        // inside++</span></span></span>
<span class="line"><span class="line"><span style="color:#88C0D0">        atomic_fetch_add</span><span style="color:#ECEFF4">(</span><span style="color:#81A1C1">&#x26;</span><span style="color:#D8DEE9FF">inside</span><span style="color:#ECEFF4">,</span><span style="color:#81A1C1"> +</span><span style="color:#B48EAD">1</span><span style="color:#ECEFF4">)</span><span style="color:#81A1C1"> ==</span><span style="color:#B48EAD"> 0</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4">    )</span><span style="color:#81A1C1">;</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#616E88">    // On some machines, printing a character will hide</span></span></span>
<span class="line"><span class="line"><span style="color:#616E88">    // the bug!</span></span></span>
<span class="line"><span class="line"><span style="color:#616E88">    // putchar('.');</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#88C0D0">    assert</span><span style="color:#ECEFF4">(</span></span></span>
<span class="line"><span class="line"><span style="color:#616E88">        // assert(inside == 1);</span></span></span>
<span class="line"><span class="line"><span style="color:#616E88">        // inside--</span></span></span>
<span class="line"><span class="line"><span style="color:#88C0D0">        atomic_fetch_add</span><span style="color:#ECEFF4">(</span><span style="color:#81A1C1">&#x26;</span><span style="color:#D8DEE9FF">inside</span><span style="color:#ECEFF4">,</span><span style="color:#81A1C1"> -</span><span style="color:#B48EAD">1</span><span style="color:#ECEFF4">)</span><span style="color:#81A1C1"> ==</span><span style="color:#B48EAD"> 1</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4">    )</span><span style="color:#81A1C1">;</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4">}</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1">int</span><span style="color:#81A1C1"> volatile</span><span style="color:#D8DEE9FF"> a </span><span style="color:#81A1C1">=</span><span style="color:#B48EAD"> 0</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9FF"> b </span><span style="color:#81A1C1">=</span><span style="color:#B48EAD"> 0</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9FF"> turn</span><span style="color:#81A1C1">;</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1">void</span><span style="color:#88C0D0"> T_A</span><span style="color:#ECEFF4">()</span><span style="color:#ECEFF4"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1">    while</span><span style="color:#ECEFF4"> (</span><span style="color:#B48EAD">1</span><span style="color:#ECEFF4">)</span><span style="color:#ECEFF4"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9FF">        a </span><span style="color:#81A1C1">=</span><span style="color:#B48EAD"> 1</span><span style="color:#81A1C1">;</span><span style="color:#D8DEE9FF">                    BARRIER</span><span style="color:#81A1C1">;</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9FF">        turn </span><span style="color:#81A1C1">=</span><span style="color:#D8DEE9FF"> B</span><span style="color:#81A1C1">;</span><span style="color:#D8DEE9FF">                 BARRIER</span><span style="color:#81A1C1">;</span><span style="color:#616E88"> // &#x3C;- this is critcal for x86</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1">        while</span><span style="color:#ECEFF4"> (</span><span style="color:#B48EAD">1</span><span style="color:#ECEFF4">)</span><span style="color:#ECEFF4"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1">            if</span><span style="color:#ECEFF4"> (</span><span style="color:#81A1C1">!</span><span style="color:#D8DEE9FF">b</span><span style="color:#ECEFF4">)</span><span style="color:#81A1C1"> break;</span><span style="color:#D8DEE9FF">        BARRIER</span><span style="color:#81A1C1">;</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1">            if</span><span style="color:#ECEFF4"> (</span><span style="color:#D8DEE9FF">turn </span><span style="color:#81A1C1">!=</span><span style="color:#D8DEE9FF"> B</span><span style="color:#ECEFF4">)</span><span style="color:#81A1C1"> break;</span><span style="color:#D8DEE9FF"> BARRIER</span><span style="color:#81A1C1">;</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4">        }</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#616E88">        // T_B can't execute critical_section now.</span></span></span>
<span class="line"><span class="line"><span style="color:#88C0D0">        critical_section</span><span style="color:#ECEFF4">()</span><span style="color:#81A1C1">;</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9FF">        a </span><span style="color:#81A1C1">=</span><span style="color:#B48EAD"> 0</span><span style="color:#81A1C1">;</span><span style="color:#D8DEE9FF">                    BARRIER</span><span style="color:#81A1C1">;</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4">    }</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4">}</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1">void</span><span style="color:#88C0D0"> T_B</span><span style="color:#ECEFF4">()</span><span style="color:#ECEFF4"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1">    while</span><span style="color:#ECEFF4"> (</span><span style="color:#B48EAD">1</span><span style="color:#ECEFF4">)</span><span style="color:#ECEFF4"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9FF">        b </span><span style="color:#81A1C1">=</span><span style="color:#B48EAD"> 1</span><span style="color:#81A1C1">;</span><span style="color:#D8DEE9FF">                    BARRIER</span><span style="color:#81A1C1">;</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9FF">        turn </span><span style="color:#81A1C1">=</span><span style="color:#D8DEE9FF"> A</span><span style="color:#81A1C1">;</span><span style="color:#D8DEE9FF">                 BARRIER</span><span style="color:#81A1C1">;</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1">        while</span><span style="color:#ECEFF4"> (</span><span style="color:#B48EAD">1</span><span style="color:#ECEFF4">)</span><span style="color:#ECEFF4"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1">            if</span><span style="color:#ECEFF4"> (</span><span style="color:#81A1C1">!</span><span style="color:#D8DEE9FF">a</span><span style="color:#ECEFF4">)</span><span style="color:#81A1C1"> break;</span><span style="color:#D8DEE9FF">        BARRIER</span><span style="color:#81A1C1">;</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1">            if</span><span style="color:#ECEFF4"> (</span><span style="color:#D8DEE9FF">turn </span><span style="color:#81A1C1">!=</span><span style="color:#D8DEE9FF"> A</span><span style="color:#ECEFF4">)</span><span style="color:#81A1C1"> break;</span><span style="color:#D8DEE9FF"> BARRIER</span><span style="color:#81A1C1">;</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4">        }</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#616E88">        // T_A can't execute critical_section now.</span></span></span>
<span class="line"><span class="line"><span style="color:#88C0D0">        critical_section</span><span style="color:#ECEFF4">()</span><span style="color:#81A1C1">;</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9FF">        b </span><span style="color:#81A1C1">=</span><span style="color:#B48EAD"> 0</span><span style="color:#81A1C1">;</span><span style="color:#D8DEE9FF">                    BARRIER</span><span style="color:#81A1C1">;</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4">    }</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4">}</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1">int</span><span style="color:#88C0D0"> main</span><span style="color:#ECEFF4">()</span><span style="color:#ECEFF4"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#88C0D0">    create</span><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9FF">T_A</span><span style="color:#ECEFF4">)</span><span style="color:#81A1C1">;</span></span></span>
<span class="line"><span class="line"><span style="color:#88C0D0">    create</span><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9FF">T_B</span><span style="color:#ECEFF4">)</span><span style="color:#81A1C1">;</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4">}</span></span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>运行结果：</p>
<p><img src="@source/learning-path/os/NJU-OS/note/img/ixRRllTon6wU14pl/1730437705076-29148737-d53f-41b1-bd81-92e939ac392a-620790.png" alt="执行失败示例"></p>
<p>我们给它重新加回 Barrier 之后，会怎么样呢？</p>
<p><img src="@source/learning-path/os/NJU-OS/note/img/ixRRllTon6wU14pl/1730437839381-9b136d2f-827c-4678-806d-5f75cde287c5-465108.png" alt="程序似乎正常运行了"></p>
<p>虽然加了 Barrier 能够使程序的行为变得“看起来”正确，但是你能确定**<font style="color:rgb(68, 136, 204);">哪些地方的 barrier 是不可少的吗</font>**<font style="color:rgb(31, 35, 40);">？</font></p>
<font style="color:rgb(31, 35, 40);">因为 Peterson 算法在现代处理器上需要添加许多屏障(或许有许多地方可以优化，但是你基本上无法确定哪些地方的屏障是必不可少的)，所以该算法在现在已经不怎么使用了。</font><h2 id="多处理器系统上的互斥" tabindex="-1"><a class="header-anchor" href="#多处理器系统上的互斥"><span><font style="color:rgb(31, 35, 40);">多处理器系统上的互斥</font></span></a></h2>
<p>实际上，互斥的根本目的是为了保证 Critical Section 操作的<strong>原子性</strong>。</p>
<p>为了在软件方面实现原子迁移，人类提出了 Dekker 算法、Peterson 算法...甚至还需要加装许多你无法完全确定如何优化的屏障来保证正确性...</p>
<p>但是，在计算机上，软硬件是互补的，因此“<strong>软件不够，硬件来凑</strong>”。</p>
<p>如果要在硬件方面实现互斥以保证 Critical Section 操作的原子性，我们也许可以小小的借用一下 Stop the World 的能力 —— 使用原子指令。</p>
<p>原子指令提供了一小段时间的“Stop the World”执行能力，为状态迁移的原子性做了保证。</p>
<ul>
<li>
<font style="color:rgb(31, 35, 40);">不可打断的 load + 计算 + store</font><ul>
<li>
<font style="color:rgb(31, 35, 40);">x86: Bus Lock; RISC-V: LR/SC (来自 MIPS) + atomic</font></li>
</ul>
</li>
</ul>
<font style="color:rgb(31, 35, 40);">有了原子指令，总算可以在多处理器上实现 并行 1 + 1 了！</font><h3 id="原子指令实现自旋锁" tabindex="-1"><a class="header-anchor" href="#原子指令实现自旋锁"><span><font style="color:rgb(31, 35, 40);">原子指令实现自旋锁</font></span></a></h3>
<blockquote>
<p>自旋锁：</p>
</blockquote>
<div class="language-c line-numbers-mode line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre v-pre  class="shiki nord vp-code" style="background-color:#2e3440ff;color:#d8dee9ff language-c"><code><span class="line"><span class="line"><span style="color:#81A1C1">int</span><span style="color:#D8DEE9FF"> status </span><span style="color:#81A1C1">=</span><span style="color:#D8DEE9FF"> ✅</span><span style="color:#81A1C1">;</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#616E88">// 这个进程状态机中只存在一个✅</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1">void</span><span style="color:#88C0D0"> lock</span><span style="color:#ECEFF4">()</span><span style="color:#ECEFF4"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9FF">retry:</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1">    int</span><span style="color:#D8DEE9FF"> got </span><span style="color:#81A1C1">=</span><span style="color:#88C0D0"> atomic_xchg</span><span style="color:#ECEFF4">(</span><span style="color:#81A1C1">&#x26;</span><span style="color:#D8DEE9FF">status</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9FF"> ❌</span><span style="color:#ECEFF4">)</span><span style="color:#81A1C1">;</span><span style="color:#616E88"> // 原子交换指令</span></span></span>
<span class="line"><span class="line"><span style="color:#616E88">    // 手慢的进程会一直在这里“自旋”</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1">    if</span><span style="color:#ECEFF4"> (</span><span style="color:#D8DEE9FF">got </span><span style="color:#81A1C1">!=</span><span style="color:#D8DEE9FF"> ✅</span><span style="color:#ECEFF4">)</span><span style="color:#ECEFF4"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1">        goto</span><span style="color:#D8DEE9FF"> retry</span><span style="color:#81A1C1">;</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4">    }</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4">}</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1">void</span><span style="color:#88C0D0"> unlock</span><span style="color:#ECEFF4">()</span><span style="color:#ECEFF4"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#88C0D0">    atomic_xchg</span><span style="color:#ECEFF4">(</span><span style="color:#81A1C1">&#x26;</span><span style="color:#D8DEE9FF">status</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9FF"> ✅</span><span style="color:#ECEFF4">)</span><span style="color:#81A1C1">;</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4">}</span></span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="一核自旋中断-多核自旋" tabindex="-1"><a class="header-anchor" href="#一核自旋中断-多核自旋"><span>一核自旋中断，多核自旋？</span></a></h3>
<p>解决方案：操作系统短暂关中断</p>
<blockquote>
<p>更新: 2024-11-01 14:39:34<br>
原文: <a href="https://www.yuque.com/yuqueyonghukaqxkk/self_learning_route/cf1ggoir94b637dw" target="_blank" rel="noopener noreferrer">https://www.yuque.com/yuqueyonghukaqxkk/self_learning_route/cf1ggoir94b637dw</a></p>
</blockquote>
</div></template>


